import yaml
import os
from datetime import datetime
from email_sender import generate_html_body, save_to_file

def load_config(config_path="config.yaml"):
    with open(config_path, "r", encoding="utf-8") as f:
        return yaml.safe_load(f)

def main():
    try:
        config = load_config()
    except FileNotFoundError:
        print("config.yaml が見つかりません。")
        return

    start_date = datetime(2026, 2, 2)
    end_date = datetime(2026, 2, 8)
    date_range_str = f"{start_date.strftime('%Y/%m/%d')} ～ {end_date.strftime('%Y/%m/%d')}"

    keyword_dict = {
        "ハイパースケールデータセンター": "GoogleやAmazonなどの巨大IT企業が利用する、超大規模なデータセンターのこと。サーバー冷却のための空調設備が巨大化しており、室外機や冷却塔からの騒音問題が地域課題化しています。",
        "環境アセスメント": "大規模な開発事業を行う際に、事前に環境への影響を調査・予測・評価する手続きのこと。騒音・振動も主要な評価項目ですが、期間短縮のための制度改正が進んでいます。",
        "低周波音": "100Hz以下の低い周波数の音。工場や風力発電のファン、ボイラーなどから発生し、「ブーン」という圧迫感のある不快音として建具をがたつかせたり、健康被害を引き起こすことがあります。",
        "Rapidus": "日本の次世代半導体製造を目指す国策企業。北海道千歳市に巨大工場を建設中で、関連するインフラ整備やサプライヤー工場の建設ラッシュが起きています。",
        "環境省": "騒音規正法などを所管する国の行政機関。",
    }

    news_data = {
        "大型プラント・インフラ動向": [
            {
                "title": "千葉県、データセンター立地で騒音規制を強化へ　冷却ファン低周波音に対応",
                "url": "https://www.pref.chiba.lg.jp/kankyou/soun/index.html",
                "source": "千葉県庁 / 日本経済新聞",
                "formatted_date": "2026年02月03日",
                "summary": "印西市などのDC集積地で、夜間の冷却ファン騒音に対する苦情が増加。県は独自の指導要綱を策定します。",
                "detail": "千葉県は、ハイパースケールデータセンターの急増に伴い、従来のアセスメント基準ではカバーしきれない「低周波音」を含む新たな騒音指導要綱を2026年度より施行します。特に屋上設置の空冷ファンに対する防音壁の高さ基準や、サイレンサー（消音器）の性能基準が見直される見通しです。",
                "reasoning": "【AI選定理由】ササクラAEの主力製品である「空冷ファン用消音器」の特需が期待できる直接的な規制強化情報です。千葉県以外の自治体（埼玉・東京）も追随する可能性が高く、先回りの提案が有効です。",
                "sales_talk": "千葉県でDCの騒音規制が強化される動きがありますが、御社が現在計画中の印西・流山のプロジェクト、冷却ファンの消音スペックは新基準を見越したものになっていますか？",
                "sales_hint": "設計事務所やサブコンに対し、「後から改修するとコストが倍になるため、今のうちにハイスペックな消音器を入れておきましょう」とスペックインを狙う絶好の口実です。"
            },
            {
                "title": "Rapidus北海道工場、2027年稼働に向け第2期棟着工　付帯設備の発注ピーク",
                "url": "https://www.rapidus.inc/news/", 
                "source": "建設工業新聞",
                "formatted_date": "2026年02月06日",
                "summary": "千歳市の次世代半導体工場、第2期工事が本格化。周辺の関連工場建設も進んでいます。",
                "detail": "Rapidus（ラピダス）のIIM-1（第1棟）に続き、IIM-2（第2棟）の基礎工事が開始されました。これに伴い、大量の受変電設備、非常用発電機、純水製造装置などの付帯設備が発注されています。これらの大型回転機器はいずれも強力な騒源となるため、防音防振対策が必須となります。",
                "reasoning": "【AI選定理由】国家プロジェクト級の超大型案件であり、予算規模も大きいためです。本体工事だけでなく、サプライヤー（素材・ガスメーカー）の周辺進出工場も狙い目です。",
                "sales_talk": "ラピダス周辺のサプライチェーン企業の工場計画も進んでいますが、非常用発電機やポンプ室の防音対策はどの段階で検討されていますか？",
                "sales_hint": "本体（鹿島建設など）は敷居が高い場合、周辺に進出する「素材メーカー」「ガス供給会社」の設備担当をターゲットにすると入り込みやすいです。"
            }
        ],
        "法規制・技術トレンド": [
            {
                "title": "洋上風力発電の環境アセス期間を半減、2026年度より新制度運用",
                "url": "https://www.meti.go.jp/policy/energy_environment/global_warming/index.html",
                "source": "経済産業省 / 環境省",
                "formatted_date": "2026年02月05日",
                "summary": "再生可能エネルギー導入加速のため、環境アセスメントの手続きが簡素化されます。",
                "detail": "政府は洋上風力発電の導入を加速させるため、通常3〜4年かかる環境アセスメントの期間を約1.5年～2年に短縮する新制度（日本版セントラル方式）を本格運用します。調査項目が絞り込まれますが、「風車騒音・低周波音」の事前シミュレーションに関しては、逆に住民説明のために高い精度が求められるようになります。",
                "reasoning": "【AI選定理由】アセス期間短縮＝事業化スピードアップです。開発事業者は「早く、正確な」騒音シミュレーションを求めているため、当社の解析技術を売り込むチャンスです。",
                "sales_talk": "アセス期間短縮の新制度で、逆に住民説明用の騒音シミュレーションの「納期」が厳しくなっていませんか？当社なら迅速に解析レポートを出せますよ。",
                "sales_hint": "開発事業者（商社・電力会社）の環境部門にアプローチし、アセス代行業者任せにせず、技術的根拠（シミュレーション）の部分請け負いを提案してください。"
            }
        ]
    }

    summary_data = {
        "text": (
            "<ul>"
            "<li><b>データセンター特需の本格化:</b> 千葉県の規制強化は、高付加価値な（高額な）高性能消音器を標準仕様にするゲームチェンジャーです。コスト勝負ではなく性能勝負に持ち込めるチャンスです。</li>"
            "<li><b>半導体・国家プロへの食い込み:</b> Rapidus関連は「スピード」と「実績」が重視されます。過去の半導体工場での納入実績リストを整理し、即座に提出できるようにしてください。</li>"
            "</ul>"
        ),
        "reasoning": "2月は年度末予算の消化案件（小規模）と、次年度の大型計画（大規模）が交錯する時期ですが、今週は特に「次年度以降の大型ルール変更」に関するニュースが多いため、長期的な種まきを促す方針にしました。",
        "evidence": "データセンター 騒音 千葉県 規制強化"
    }
    
    proposal_data = {
        "text": (
            "<ul>"
            "<li><b>DC空調サブコンへの集中訪問:</b> 特にデータセンター実績の多いサブコン（高砂熱学、新菱冷熱など）の設計部に対し、「千葉県新条例対応スペック」と銘打った技術資料を持参してください。</li>"
            "<li><b>B2B展示会への出展検討:</b> 6月開催の「データセンター構築展」への出展、または視察計画を立ててください。競合他社のDC向け防音製品の調査が必要です。</li>"
            "</ul>"
        ),
        "reasoning": "「規制強化」という外部要因は、営業にとって最強の武器です。顧客（サブコン）も対応に困っているはずなので、ソリューション（解決策）を持っていくことで「相談されるパートナー」になれます。",
        "evidence": "データセンター構築展 2026 東京ビッグサイト"
    }
    
    chart_data = {
        "title": "国内データセンター電力消費量予測 (冷却需要)",
        "source": "科学技術振興機構 (JST) 低炭素社会戦略センター",
        "config": {
            "type": "bar",
            "data": {
                "labels": ["2024", "2025", "2026(予)", "2027(予)", "2028(予)"],
                "datasets": [{
                    "label": "電力消費量 (TWh)",
                    "data": [20, 26, 35, 50, 75],
                    "backgroundColor": "#003366"
                }]
            },
            "options": {
                "title": {"display": False},
                "scales": {
                    "yAxes": [{"ticks": {"beginAtZero": True}}]
                }
            }
        },
        "reasoning": "電力消費の大半はサーバー冷却（空調）です。このグラフの伸び率は、そのまま「冷却ファン騒音対策」の市場拡大率と読み替えることができます。",
        "evidence": "データセンター 電力消費量 予測 日本"
    }

    glossary = {
        "セントラル方式": {
            "desc": "洋上風力発電において、国が主導して初期段階の風況調査や環境アセスメントを行う仕組み。事業者の負担を減らし、導入を加速させる狙いがある。"
        }
    }

    html_body = generate_html_body(
        news_data, 
        date_range_str=date_range_str,
        summary_data=summary_data,
        proposal_data=proposal_data,
        chart_data=chart_data,
        glossary=glossary,
        keyword_dict=keyword_dict
    )
    
    output_files_dir = "output"
    os.makedirs(output_files_dir, exist_ok=True)
    output_path = os.path.join(output_files_dir, "weekly_newsletter_v18.html")
    save_to_file(html_body, output_path)
    
    print(f"完了しました。確認してください: {output_path}")

if __name__ == "__main__":
    main()
